name: Build CoreELEC for E900V22C

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'CoreELEC version (e.g., 21.3-Omega)'
        required: true
        default: '21.3-Omega'
      keep_releases:
        description: 'Number of old releases to keep (0 to disable cleanup)'
        required: false
        default: '3'

env:
  TZ: Asia/Shanghai
  BUILD_DIR: /tmp/coreelec-build

jobs:
  build:
    runs-on: ubuntu-24.04
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Setup build environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          wget \
          gzip \
          squashfs-tools \
          unsquashfs \
          mount \
          kpartx \
          jq
        sudo apt-get autoremove -y
        sudo apt-get clean
        sudo timedatectl set-timezone "$TZ"
        
    - name: Create build directory
      run: |
        mkdir -p "$BUILD_DIR"
        chmod 755 "$BUILD_DIR"
    
    - name: Run build script
      env:
        VERSION: ${{ github.event.inputs.version }}
      run: |
        chmod +x build.sh
        ./build.sh "$VERSION"
        
        # Set environment variables
        echo "BUILD_DATE=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV
        echo "BUILD_VERSION=$VERSION" >> $GITHUB_ENV
        
        # Collect artifacts
        mkdir -p artifacts
        cp -v ./*.img.gz artifacts/ 2>/dev/null || true
        cp -v ./*.img.gz.sha256 artifacts/ 2>/dev/null || true
        cp -v ./*.img.gz.md5 artifacts/ 2>/dev/null || true
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: coreelec-build-${{ env.BUILD_DATE }}
        path: artifacts/
        retention-days: 7
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ env.BUILD_VERSION }}-${{ env.BUILD_DATE }}
        name: CoreELEC ${{ env.BUILD_VERSION }} for E900V22C
        body: |
          # CoreELEC ${{ env.BUILD_VERSION }} for Skyworth E900V22C
          
          **Build Information:**
          - Version: ${{ env.BUILD_VERSION }}
          - Build Date: ${{ env.BUILD_DATE }}
          - Built with GitHub Actions
          
          **Files included:**
          - Compressed system image (.img.gz)
          - SHA256 checksum (.img.gz.sha256)
          - MD5 checksum (.img.gz.md5)
          
          **Usage:**
          1. Extract the .img.gz file
          2. Write the .img file to USB/SD card
          3. Boot from the media
          
          **Source:** [GitHub Repository](https://github.com/${{ github.repository }})
        files: artifacts/*
        draft: false
        prerelease: false
    
    - name: Clean up old releases (using GH CLI)
      # 修复条件判断：当 keep_releases 存在且不等于 '0' 时执行
      if: ${{ github.event.inputs.keep_releases && github.event.inputs.keep_releases != '0' }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        KEEP_COUNT: ${{ github.event.inputs.keep_releases }}
      run: |
        echo "Starting cleanup: keeping latest $KEEP_COUNT release(s)"
        
        # 获取所有 releases，按创建时间降序排序
        releases_json=$(gh release list --json tagName,createdAt --limit 50 --order desc)
        
        # 提取标签名到数组
        all_tags=()
        while IFS= read -r tag; do
          all_tags+=("$tag")
        done < <(echo "$releases_json" | jq -r '.[].tagName')
        
        echo "Total releases found: ${#all_tags[@]}"
        
        # 删除超过保留数量的旧发布
        for (( i=KEEP_COUNT; i<${#all_tags[@]}; i++ )); do
          tag="${all_tags[$i]}"
          # 只删除匹配特定模式的标签（v开头，包含日期）
          if [[ "$tag" =~ ^v.*-.* ]]; then
            echo "Deleting old release: $tag"
            # 先尝试删除 release，如果失败则尝试删除 tag
            if gh release delete "$tag" --yes; then
              echo "Successfully deleted release: $tag"
            else
              echo "Failed to delete release $tag, it might not exist or already deleted"
            fi
          fi
        done
        
        echo "Cleanup completed"
    
    - name: Clean up build directory
      if: always()
      run: |
        sudo rm -rf "$BUILD_DIR" || true
        rm -rf artifacts || true
